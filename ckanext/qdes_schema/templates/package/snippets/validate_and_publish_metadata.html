{% import 'macros/form.html' as form %}

{% set is_public = not pkg.private %}
{% set is_official_public = 'official-public' in pkg.classification_and_access_restrictions %}

{% if not is_public %}
  <div class="alert alert-info" role="alert">
    The dataset's visibility is currently set to "Private" and cannot be published. Please change the visibility setting to "Public before publishing."
  </div>
{% elif not is_official_public %}
  <div class="alert alert-info" role="alert">
    The dataset's classification and access restriction does not permit publishing. Only datasetâ€™s with a classification of "OFFICIAL-PUBLIC" can be published.
  </div>
{% else %}

  <details class="row validate-publish" open data-valid="{{ valid }}">
    <summary>Validate and publish records</summary>
    <h2>Validate and publish records</h2>
    <form method="post" action="{{ h.url_for('qdes_schema.datasets_schema_validation', id=pkg.id) }}" novalidate>
      <div class="row">
        <div class="col-md-4">
          <label>
            Select distribution to publish
          </label>
        </div>
        <div class="col-md-8">
          <div class="form-group">
            {%- set schema = h.scheming_get_dataset_schema(pkg.type) -%}
            {%- set ns = namespace() -%}
            {%- for field in schema.resource_fields -%}
              {% if field.field_name == 'format' %}
                {%- set ns.format_field = field -%}
              {% endif %}
            {%- endfor -%}

            {% if not pkg.resources %}
              No distributions.
            {% endif %}

            {% for resource in pkg.resources %}
              <label class="no-colon">
                <input class="resources" type="checkbox" name="resources" value="{{ resource.id }}" {{ 'checked="checked"' if resource.id in data['resources'] else '' }} />
                {{ h.scheming_choices_label(h.scheming_field_choices(ns.format_field), resource.format) }} - {{ resource.name }}
              </label>
              {% if not loop.last %}
                <br/>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <label for="schema">Select schema to validate/publish</label>
        </div>
        <div class="col-md-8">
          <div class="form-group">
            <select id="schema" name="schema" class="form-control">
              {% for option in options %}
                <option value="{{ option.value }}" {{ 'selected="selected"' if data['schema'] == option.value else '' }}>{{ option.text }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <div class="row form-group">
        <div class="col-md-10">
          {% if pkg_errors or res_errors %}
            {%- set schema = h.scheming_get_dataset_schema(pkg.type) -%}
            <div class="error-explanation alert alert-error" role="alert">
              <p>The <strong>{{ pkg.title if pkg.title else pkg.name }} dataset</strong> contains the following errors when validated against the <strong>{{ selected_opt.text }}</strong> schema:</p>

              {% if pkg_errors %}
                <br/>
                <ul>
                  {% for key, error in pkg_errors.items() %}
                    <li>
                      <a target="_blank" href="{{ h.url_for('dataset.edit', id=pkg.id) }}#field-{{key}}">
                        <strong>{{ h.qdes_get_field_label(key, schema) }}</strong></a> : {{ error|join(', ') }}
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}

              {% if res_errors %}
                <br/>
                <h2>Resources:</h2>
                {% for res in res_errors %}
                  {% if loop.index > 1 %}
                    <br/>
                  {% endif %}

                  <p>The <strong>{{ res.resource_name }}</strong> resource contains the following errors when validated against the <strong>{{ selected_opt.text }}</strong> schema:</p>
                  <br/>
                  <ul>
                    {% for err in res.errors %}
                      {% for key, key_error in err.items() %}
                        <li>
                          <a target="_blank" href="{{ h.url_for(pkg.type + '_resource.edit', id=pkg.id, resource_id=res.resource_id) }}#field-{{key}}">
                            <strong>{{ h.qdes_get_field_label(key, schema, 'resource_fields') }}</strong></a> : {{ key_error|join(', ') }}
                        </li>
                      {% endfor %}
                    {% endfor %}
                  </ul>
                {% endfor %}

              {% endif %}
            </div>
          {% elif selected_opt.text %}
            <div class="alert alert-success" role="alert">
              The <strong>{{ pkg.title if pkg.title else pkg.name }} dataset</strong> has no errors when validated against the <strong>{{ selected_opt.text }}</strong> schema.
            </div>
          {% endif %}
        </div>
        <div class="col-md-2">
          {% if is_public and is_official_public %}
            <button class="btn btn-default btn-block validate" type="submit" name="action" value="validate" disabled>Validate</button>
          {% endif %}
        </div>
      </div>

      <div class="row form-group">
        <div class="col-md-10">
          {% if publication_message %}
            <div class="alert {{ publication_message.cls }}" role="alert">
              {{ publication_message.text }}
            </div>
          {% endif %}
        </div>
        <div class="col-md-2">
          {% if is_public and is_official_public %}
            <button
              data-module="publish-confirm-action"
              data-module-content="Has the metadata record gone through the relevant business review / approval process to publish?"
              data-module-content-cancel="The distribution can not be published without the relevant business review / approval process."
              data-module-with-data="true"
              class="btn btn-default btn-block publish"
              type="submit" name="action" value="publish" disabled>Publish</button>
          {% endif %}
        </div>
      </div>
    </form>
  </details>

{% endif %}
