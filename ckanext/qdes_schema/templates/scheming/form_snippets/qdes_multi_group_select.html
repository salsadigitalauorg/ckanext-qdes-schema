{% import 'macros/form.html' as form %}

<div id="{{ field.field_name }}-repeater" class="repeating-field" data-field-type="select">
    <label class="control-label" for="field-{{ field.field_name }}">{{ field.label }}</label>
    {% if errors[field.field_name] and errors[field.field_name] is iterable %}<span class="error-block">{{ errors[field.field_name]|join(', ') }}</span>{% endif %}
    <div data-repeater-list="{{ field.field_name }}">

        {% set values = h.get_multi_textarea_values(data[field.field_name]) or [] %}

        {% for row in range(values['count'] or 1)  %}   

          <div data-repeater-item class="row vertical-align">
            {% for field_group in field.get('field_group') or [] %}          

              <div class="col-lg-{{ 12 // field.get('field_group')|length }}">              
                  {%- set options=[] -%}
                  {%- set form_restrict_choices_to=field_group.get('form_restrict_choices_to') -%}
                  {%- if not h.scheming_field_required(field_group) or
                    field_group.get('form_include_blank_choice', false) -%}
                    {%- do options.append({'value': '', 'text': ''}) -%}
                  {%- endif -%}
                  {%- for c in h.scheming_field_choices(field_group) -%}
                    {%- if not form_restrict_choices_to or c.value in form_restrict_choices_to -%}
                      {%- do options.append({
                        'value': c.value|string,
                        'text': h.scheming_language_text(c.label) }) -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- if field_group.get('sorted_choices') -%}
                    {%- set options = options|sort(case_sensitive=false, attribute='text') -%}
                  {%- endif -%}
                  {%- if field_group.get('first_choice') -%}
                    {%- set options = h.set_first_option(options, field_group.get('first_choice')) -%}
                  {%- endif -%}
                  {%- if values[field_group.field_name] -%}
                    {%- set option_selected = values[field_group.field_name][row]|string -%}
                  {%- else -%}
                    {%- set option_selected = None -%}
                  {%- endif -%}
                  
                  {% call form.select(
                      label=h.scheming_language_text(field_group.label),
                      options=options,
                      selected=option_selected,
                      error=errors[field_group.field_name],
                      classes=['control-medium'],
                      attrs=dict({"data-group": true, "data-field-name": field_group.field_name, "data-parent-field-name": field.field_name}, **(field_group.get('form_attrs', {}))),
                      is_required=h.scheming_field_required(field_group)
                      )
                  %}
                      {%- snippet 'scheming/form_snippets/help_text.html', field=field_group -%}
                  {% endcall %}
              </div>
            {% endfor %}            
            <div class="col-lg-1">
                  <input data-repeater-delete type="button" class="btn btn-sm btn-danger" value="-" title="Remove item" />
            </div>
          </div>
        {% endfor %}

    </div>
    <div class="row" align="center">
        <input data-repeater-create type="button" class="btn" value="+" />
    </div>
</div>

{% set visibility = [] if g.debug else ['hidden'] %}
{% set default_classes = field.classes if 'classes' in field else [] %}
{% set ns = namespace(field_classes=default_classes + visibility) %}

{# BEGIN: The actual form field the multiple values will be captured & submitted in #}
{% call form.textarea(
    field.field_name,
    id='field-' + field.field_name,
    label=h.scheming_language_text(field.label),
    value=data[field.field_name],
    classes=ns.field_classes,
    )
%}
    {%- snippet 'scheming/form_snippets/help_text.html', field=field -%}
{% endcall %}
{# END: The actual form field the multiple values will be captured & submitted in #}
